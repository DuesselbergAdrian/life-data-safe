# ðŸš€ Deployment Guide

Complete guide for deploying Health Vault to production.

---

## Prerequisites

- Lovable account (free tier works)
- Git repository access
- Domain name (optional, for custom domains)

---

## Deployment via Lovable

### Quick Deploy

Health Vault is deployed automatically via Lovable's integrated deployment system.

**Steps:**

1. **Open your project** in Lovable
2. **Click "Publish"** in the top-right corner (desktop) or bottom-right (mobile)
3. **Review changes** in the deployment dialog
4. **Click "Update"** to deploy frontend changes

**Note:** Backend changes (edge functions, database migrations) deploy automatically!

### Deployment URLs

- **Staging**: `https://your-project-id.lovable.app`
- **Production**: Same URL (or custom domain if configured)

---

## Environment Configuration

### Environment Variables

Automatically configured by Lovable Cloud:

```bash
VITE_SUPABASE_URL=https://yoqsviiqmkdeurzipdmq.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=your-anon-key
VITE_SUPABASE_PROJECT_ID=yoqsviiqmkdeurzipdmq
```

### Secrets Management

Secrets are managed via Lovable Cloud backend:

1. Go to **Cloud** tab â†’ **Settings** â†’ **Secrets**
2. Add required secrets:
   - `DUST_API_KEY` - For Dust AI agent
   - `OPENAI_API_KEY` - For OpenAI integration
   - `META_GLASSES_API_KEY` - For Meta video analysis (if applicable)

**Security:** Secrets are encrypted at rest and only accessible to edge functions.

---

## Custom Domain Setup

### Connect a Custom Domain

1. Navigate to **Project â†’ Settings â†’ Domains**
2. Click **"Connect Domain"**
3. Enter your domain (e.g., `healthvault.com`)
4. Follow DNS configuration instructions:

**DNS Records (Example):**
```
Type: A
Name: @
Value: 76.76.21.21

Type: CNAME
Name: www
Value: your-project.lovable.app
```

5. Wait for DNS propagation (5-60 minutes)
6. SSL certificate auto-generated by Lovable

**Note:** Custom domains require a paid Lovable plan.

---

## Database Migrations

### Automatic Deployment

Database migrations are automatically deployed when you:
- Create new tables via Lovable Cloud UI
- Run SQL migrations via the migration tool
- Update RLS policies

### Manual Migration (if needed)

If you need to run custom SQL:

1. Go to **Cloud** tab â†’ **Database**
2. Use the migration tool through Lovable AI
3. Or run migrations via Supabase CLI (advanced)

**Example Migration:**
```sql
-- Add a new column
ALTER TABLE health_metrics 
ADD COLUMN IF NOT EXISTS quality_score INTEGER;

-- Create index
CREATE INDEX IF NOT EXISTS idx_health_quality 
ON health_metrics(quality_score);
```

---

## Edge Functions Deployment

### Automatic Deployment

Edge functions deploy automatically when you:
- Edit function code
- Save changes in Lovable editor

**Deployment Time:** ~30-60 seconds

### Verify Deployment

Check edge function logs:
1. Go to **Cloud** tab â†’ **Functions**
2. Select function name
3. View **Logs** tab for deployment status

**Test Endpoint:**
```bash
curl -X POST https://yoqsviiqmkdeurzipdmq.supabase.co/functions/v1/analyze-health-data \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"metrics": []}'
```

---

## Frontend Build

### Build Process

Lovable automatically builds your frontend using Vite:

```bash
# Equivalent to:
npm run build

# Output: dist/
# - index.html
# - assets/
#   - main-[hash].js
#   - main-[hash].css
```

### Build Optimization

**Automatic Optimizations:**
- Code splitting
- Tree shaking
- Minification
- Asset compression (gzip, brotli)
- Image optimization

---

## Performance Optimization

### CDN Configuration

Static assets automatically cached via CDN:
- **Cache Duration**: 1 year for hashed assets
- **Invalidation**: Automatic on new deployments
- **Geographic Distribution**: Global edge network

### Database Optimization

**Indexes Created:**
```sql
CREATE INDEX idx_health_metrics_user_time 
ON health_metrics(user_id, recorded_at DESC);

CREATE INDEX idx_devices_user_status 
ON devices(user_id, sync_status);
```

**Connection Pooling:**
- Enabled by default via PgBouncer
- Max connections: 15 (adjustable in settings)

---

## Monitoring & Logging

### Application Logs

**Edge Function Logs:**
1. Cloud tab â†’ Functions â†’ Select function
2. View real-time logs
3. Filter by severity (info, warn, error)

**Database Logs:**
1. Cloud tab â†’ Database â†’ Logs
2. View query performance
3. Monitor slow queries

### Performance Metrics

**Key Metrics to Monitor:**
- Request latency (p50, p95, p99)
- Error rate (target: <1%)
- Database query time
- Edge function cold start time

**Access Metrics:**
- Lovable Dashboard â†’ Analytics
- Real-time visitor tracking
- Performance insights

---

## Backup & Recovery

### Database Backups

**Automatic Backups:**
- **Frequency**: Every 6 hours
- **Retention**: 7 days (free tier), 30 days (paid)
- **Storage**: Encrypted at rest

**Manual Backup:**
```bash
# Export via Lovable Cloud UI
1. Cloud tab â†’ Database â†’ Export
2. Select tables or full database
3. Download as SQL or CSV
```

### Restore from Backup

```bash
# Contact Lovable support for point-in-time recovery
# Or restore manually from exported SQL
```

---

## Security Hardening

### SSL/TLS

- **Certificate**: Auto-generated Let's Encrypt
- **Protocol**: TLS 1.3
- **HSTS**: Enabled by default

### Content Security Policy

Add to `index.html`:
```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline';
               img-src 'self' data: https:;
               connect-src 'self' https://yoqsviiqmkdeurzipdmq.supabase.co;">
```

### Rate Limiting

**Configured in Edge Functions:**
```typescript
const RATE_LIMIT = 100; // requests per minute

// Check rate limit before processing
if (requestCount > RATE_LIMIT) {
  return new Response('Rate limited', { status: 429 });
}
```

---

## Rollback Procedure

### Frontend Rollback

1. Go to **Project â†’ Settings â†’ Versions**
2. Select previous working version
3. Click **"Restore"**
4. Confirm and deploy

**Downtime:** ~30 seconds

### Database Rollback

**Important:** Database migrations cannot be automatically rolled back.

**Manual Rollback:**
1. Write reverse migration SQL
2. Run via migration tool
3. Test thoroughly in staging first

**Example Reverse Migration:**
```sql
-- Rollback: Remove column
ALTER TABLE health_metrics 
DROP COLUMN IF EXISTS quality_score;

-- Rollback: Drop index
DROP INDEX IF EXISTS idx_health_quality;
```

---

## CI/CD Pipeline (Optional)

For teams wanting more control, connect to GitHub Actions:

### GitHub Actions Workflow

**.github/workflows/deploy.yml**
```yaml
name: Deploy to Lovable

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Build
        run: npm run build
      
      - name: Deploy to Lovable
        run: |
          # Lovable auto-deploys on git push
          echo "Deployment triggered automatically"
```

---

## Staging vs Production

### Two-Environment Setup

**Staging (Automatic):**
- Auto-deploy on every commit to `main`
- Full feature parity with production
- Use for QA testing

**Production (Manual):**
- Manual trigger via "Publish" button
- Review changes before deploy
- Use for live traffic

### Environment-Specific Config

```typescript
const config = {
  staging: {
    apiUrl: 'https://staging.healthvault.com',
    analytics: false,
    debugMode: true
  },
  production: {
    apiUrl: 'https://healthvault.com',
    analytics: true,
    debugMode: false
  }
};

const env = import.meta.env.MODE;
export default config[env] || config.production;
```

---

## Post-Deployment Checklist

- [ ] Verify homepage loads correctly
- [ ] Test user authentication (signup/login)
- [ ] Check database connectivity
- [ ] Verify edge functions are responding
- [ ] Test AI features (Dust agent, OpenAI chat)
- [ ] Check mobile responsiveness
- [ ] Verify SSL certificate is active
- [ ] Monitor error logs for 1 hour
- [ ] Test key user flows (device sync, data upload)
- [ ] Verify analytics tracking

---

## Troubleshooting

### Common Issues

**Issue: 502 Bad Gateway**
- **Cause**: Edge function timeout or error
- **Solution**: Check function logs, increase timeout limit

**Issue: Database connection errors**
- **Cause**: Connection pool exhausted
- **Solution**: Increase pool size in settings

**Issue: Slow page loads**
- **Cause**: Large bundle size
- **Solution**: Enable code splitting, optimize images

**Issue: Auth not working**
- **Cause**: Incorrect redirect URLs
- **Solution**: Update URLs in Cloud â†’ Auth â†’ Settings

---

## Support & Resources

- **Lovable Docs**: https://docs.lovable.dev
- **Lovable Discord**: [Join Community](https://discord.gg/lovable)
- **Supabase Docs**: https://supabase.com/docs
- **Status Page**: https://status.lovable.dev

---

<div align="center>
  <strong>Deploy with confidence using Lovable's automated platform</strong>
</div>
